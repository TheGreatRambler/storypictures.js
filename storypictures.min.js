/* Copyright TheGreatRambler 2018 */
(function(m,a){"function"===typeof define&&define.amd?define(["ROT"],a):"object"===typeof module&&module.exports?module.exports=a(require("ROT")):m.storypictures=a(m.ROT)})("undefined"!==typeof self?self:this,function(m){return function(a){function n(k){var f=[],p=0,b=document.createElement("canvas").getContext("2d");b.mozImageSmoothingEnabled=!1;b.webkitImageSmoothingEnabled=!1;b.msImageSmoothingEnabled=!1;b.imageSmoothingEnabled=!1;b.canvas.width=Math.round(h.width*k);b.canvas.height=Math.round(h.height*
k);b.drawImage(h,0,0,b.canvas.width,b.canvas.height);data32=new Uint32Array(b.getImageData(0,0,b.canvas.width,b.canvas.height).data.buffer);var d=new ArrayBuffer(4);k=new Uint32Array(d);d=new Uint8Array(d);k[0]=3735928559;k=239==d[0]?!0:222==d[0]?!1:void 0;for(i=0;i<data32.length;i++){d=i%b.canvas.width;var l=i/b.canvas.width|0;d=d>=l?d*d+d+l:l*l+d;if(k){l=data32[i]&255;var g=data32[i]>>8&255;var e=data32[i]>>16&255;var c=data32[i]>>24&255}else l=data32[i]>>24&255,g=data32[i]>>16&255,e=data32[i]>>
8&255,c=data32[i]&255;a.tileOpen(l,g,e,c)&&(p++,f[d]=a.color?"rgb("+l+","+g+","+e+");":!0)}return{pixels:f,spotsopen:p,width:b.canvas.width,height:b.canvas.height}}if(a.img instanceof HTMLImageElement){var h=document.createElement("canvas");h.width=a.img.width;h.height=a.img.height;var c=h.getContext("2d");c.drawImage(a.img,0,0)}else if(a.img instanceof CanvasRenderingContext2D)h=a.img.context,c=a.img;else throw new TypeError("Image must context or image element");a.story=a.story.replace(/(?:\r\n|\r|\n)/g,
"");a.tileOpen||(a.tileOpen=function(a,f,c,b){return 40>.2126*a+.7152*f+.0722*c?!1:!0});c=n(1);c=1*Math.sqrt(a.story.length/(2*c.spotsopen));var q=n(c);return function(c,f){function h(a,c,e){l?"[object Object]"===Object.prototype.toString.call(f[d])?f[d].c?b.draw(a,c,f[d].n,f[d].c):b.draw(a,c,f[d]):e?b.draw(a,c,f[d],e):b.draw(a,c,f[d]):e?b.draw(a,c,f.charAt(d),e):b.draw(a,c,f.charAt(d));d++}for(var b=new m.Display({width:2*c.width,height:c.height,forceSquareRatio:!1,fontSize:12,bg:"#FFFFFF",fg:"#000000"}),
d=0,l=f.constructor===Array,g=0;g<c.height;g++)for(var e=0;e<c.width;e++){var k=c.pixels[e>=g?e*e+e+g:g*g+e];k&&(a.color?(h(2*e,g,k),h(2*e+1,g,k)):(h(2*e,g),h(2*e+1,g)))}return b._context}(n(Math.sqrt(a.story.length/(2*q.spotsopen))*c),a.story)}});

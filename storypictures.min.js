/* Copyright TheGreatRambler 2018 */
(function(n,a){"function"===typeof define&&define.amd?define(["ROT"],a):"object"===typeof module&&module.exports?module.exports=a(require("ROT")):n.storypictures=a(n.ROT)})("undefined"!==typeof self?self:this,function(n){return function(a){return new Promise(function(r,t){function m(e){var d=[],p=0,f=document.createElement("canvas").getContext("2d");f.canvas.width=Math.round(k.width*e);f.canvas.height=Math.round(k.height*e);f.drawImage(k,0,0,f.canvas.width,f.canvas.height);data32=new Uint32Array(f.getImageData(0,
0,f.canvas.width,f.canvas.height).data.buffer);var c=new ArrayBuffer(4);e=new Uint32Array(c);c=new Uint8Array(c);e[0]=3735928559;e=239==c[0]?!0:222==c[0]?!1:void 0;for(i=0;i<data32.length;i++){c=i%f.canvas.width;var l=i/f.canvas.width|0;c=c>=l?c*c+c+l:l*l+c;if(e){l=data32[i]&255;var b=data32[i]>>8&255;var g=data32[i]>>16&255;var h=data32[i]>>24&255}else l=data32[i]>>24&255,b=data32[i]>>16&255,g=data32[i]>>8&255,h=data32[i]&255;a.tileOpen(l,b,g,h)&&(p++,d[c]=a.color?"rgb("+l+","+b+","+g+");":!0)}return{pixels:d,
spotsopen:p,width:f.canvas.width,height:f.canvas.height}}function q(e){var d=Array(e||0),a=e;if(1<arguments.length)for(var f=Array.prototype.slice.call(arguments,1);a--;)d[e-1-a]=q.apply(this,f);return d}function u(a){var d=[];a.forEach(function(a){d.push(a.join(""))});return d.join("\n")}if(a.img instanceof HTMLImageElement){var k=document.createElement("canvas");k.width=a.img.width;k.height=a.img.height;var b=k.getContext("2d");b.drawImage(a.img,0,0)}else a.img instanceof CanvasRenderingContext2D?
(k=a.img.canvas,b=a.img):t("Image must context or image element");a.story=a.story.replace(/(?:\r\n|\r|\n)/g,"");a.tileOpen||(a.tileOpen=function(a,d,b,f){return 40>.2126*a+.7152*d+.0722*b?!1:!0});b=m(1);b=1*Math.sqrt(a.story.length/(2*b.spotsopen));var v=m(b);b=function(e,d){function b(a,b,e){l?"[object Object]"===Object.prototype.toString.call(d[c])?d[c].c?(f.draw(a,b,d[c].n,d[c].c),k[a][b]=d[c].n):(f.draw(a,b,d[c]),k[a][b]=d[c]):(e?f.draw(a,b,d[c],e):f.draw(a,b,d[c]),k[a][b]=d[c]):(e?f.draw(a,b,
d.charAt(c),e):f.draw(a,b,d.charAt(c)),k[a][b]=d.charAt(c));c++}for(var f=new n.Display({width:2*e.width,height:e.height,forceSquareRatio:!1,fontSize:12,bg:"#FFFFFF",fg:"#000000"}),c=0,l=d.constructor===Array,k=q(2*e.width,e.height),g=0;g<e.height;g++)for(var h=0;h<e.width;h++){var m=e.pixels[h>=g?h*h+h+g:g*g+h];m&&(a.color?(b(2*h,g,m),b(2*h+1,g,m)):(b(2*h,g),b(2*h+1,g)))}return{context:f._context,text:u(k)}}(m(Math.sqrt(a.story.length/(2*v.spotsopen))*b),a.story);r(b)})}});

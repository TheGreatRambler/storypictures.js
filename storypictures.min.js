/* Copyright TheGreatRambler 2018 */
(function(p,a){"function"===typeof define&&define.amd?define(["ROT"],a):"object"===typeof module&&module.exports?module.exports=a(require("ROT")):p.storypictures=a(p.ROT)})("undefined"!==typeof self?self:this,function(p){return function(a){function q(b){var d=[],l=0,e=document.createElement("canvas").getContext("2d");e.canvas.width=Math.round(h.width*b);e.canvas.height=Math.round(h.height*b);e.drawImage(h,0,0,e.canvas.width,e.canvas.height);data32=new Uint32Array(e.getImageData(0,0,e.canvas.width,
e.canvas.height).data.buffer);var c=new ArrayBuffer(4);b=new Uint32Array(c);c=new Uint8Array(c);b[0]=3735928559;b=239==c[0]?!0:222==c[0]?!1:void 0;for(i=0;i<data32.length;i++){c=i%e.canvas.width;var k=i/e.canvas.width|0;c=c>=k?c*c+c+k:k*k+c;if(b){k=data32[i]&255;var m=data32[i]>>8&255;var f=data32[i]>>16&255;var g=data32[i]>>24&255}else k=data32[i]>>24&255,m=data32[i]>>16&255,f=data32[i]>>8&255,g=data32[i]&255;a.tileOpen(k,m,f,g)&&(l++,d[c]=a.color?"rgb("+k+","+m+","+f+");":!0)}return{pixels:d,spotsopen:l,
width:e.canvas.width,height:e.canvas.height}}function r(b){var d=Array(b||0),a=b;if(1<arguments.length)for(var e=Array.prototype.slice.call(arguments,1);a--;)d[b-1-a]=r.apply(this,e);return d}function t(a){var d=[];a.forEach(function(a){d.push(a.join(""))});return d.join("\n")}if(a.img instanceof HTMLImageElement){var h=document.createElement("canvas");h.width=a.img.width;h.height=a.img.height;var n=h.getContext("2d");n.drawImage(a.img,0,0)}else if(a.img instanceof CanvasRenderingContext2D)h=a.img.canvas,
n=a.img;else throw new TypeError("Image must context or image element");a.story=a.story.replace(/(?:\r\n|\r|\n)/g,"");a.tileOpen||(a.tileOpen=function(a,d,l,e){return 40>.2126*a+.7152*d+.0722*l?!1:!0});n=q(1);n=1*Math.sqrt(a.story.length/(2*n.spotsopen));var u=q(n);return function(b,d){function l(a,b,f){k?"[object Object]"===Object.prototype.toString.call(d[c])?d[c].c?(e.draw(a,b,d[c].n,d[c].c),m[a][b]=d[c].n):(e.draw(a,b,d[c]),m[a][b]=d[c]):(f?e.draw(a,b,d[c],f):e.draw(a,b,d[c]),m[a][b]=d[c]):(f?
e.draw(a,b,d.charAt(c),f):e.draw(a,b,d.charAt(c)),m[a][b]=d.charAt(c));c++}for(var e=new p.Display({width:2*b.width,height:b.height,forceSquareRatio:!1,fontSize:12,bg:"#FFFFFF",fg:"#000000"}),c=0,k=d.constructor===Array,m=r(2*b.width,b.height),f=0;f<b.height;f++)for(var g=0;g<b.width;g++){var h=b.pixels[g>=f?g*g+g+f:f*f+g];h&&(a.color?(l(2*g,f,h),l(2*g+1,f,h)):(l(2*g,f),l(2*g+1,f)))}return{context:e._context,text:t(m)}}(q(Math.sqrt(a.story.length/(2*u.spotsopen))*n),a.story)}});
